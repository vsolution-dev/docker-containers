version: '3.9'

networks:
  tor:
    name: tor
    driver: bridge

services:
  tor-1:
    build:
      context: ./tor
    image: tor
    container_name: tor-1
    restart: always
    networks:
      - tor
    environment:
      - INSTANCES=3

  tor-2:
    extends:
      service: tor-1
    container_name: tor-2

  tor-3:
    extends:
      service: tor-1
    container_name: tor-3

  tor-4:
    extends:
      service: tor-1
    container_name: tor-4

  tor-5:
    extends:
      service: tor-1
    container_name: tor-5

  tor:
    image: haproxy:latest
    container_name: tor
    ports:
      - "9050:9050"
      - "8050:8050"
      - "14567:14567"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    networks:
      - tor
    depends_on:
      - tor-1
      - tor-2
      - tor-3
      - tor-4
      - tor-5
